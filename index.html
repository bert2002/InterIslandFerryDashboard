<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="refresh" content="50">
    <title>Inter Island Magic Mirror Page</title>
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="dist/css/helper.css" rel="stylesheet">
    <script src="dist/js/helper.js"></script>
    <script src="dist/js/config.js"></script>
    <script src="dist/js/HongKongHolidays.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <!-- Instagram -->
    <script src="dist/js/jquery.instagramFeed.min.js"></script>
    <!-- Weather -->
    <script src="dist/js/openweather.js"></script>
  </head>
  <body class="py-4 text-white bg-dark">
    <div class="container-fluid">

      <div class="row mb-5">
        <div class="col-8 themed-grid-col">
          <h5><span id="weekday"></span>, <span id="day"></span> <span id="month"></span> <span id="year"></span></h5>
          <span class="display-1" id="date"></span>
        </div>
        <div class="col-4 themed-grid-col"></div>
      </div>

      <div class="row mb-5">
        <div class="col-8 themed-grid-col">
          <u><h5><span id="FerryScheduleName"></span></u> <span id="HolidayFlag"></span></h5>
          <h2><span id="FerryType"></span><span id="FullText"></span></h2>
        </div>
        <div class="col-4 themed-grid-col"></div>
      </div>

      <div class="row mb-5 mt-50">
        <div class="col-12 themed-grid-col">
          <div class="hide" id="temperature">
            <img src="" class="weather-icon"/> <h4><span class="weather-temperature ml-2 mr-2"></span><small><span class="weather-description"></span></small></h4><br>
          </div>
          <div class="hide" id="humidity">
            <img src="dist/img/weather/humidity.png" class="mt-3" /> <h4><span class="weather-humidity ml-2 mr-2"></span></h4><br>
          </div>
          <div class="hide" id="wind">
            <img src="dist/img/weather/speed.png" class="mt-3"/> <h4><span class="weather-wind-speed ml-2 mr-2"></span></h4><br>
          </div>
          <div class="hide" id="sunrise">
            <img src="dist/img/weather/sunrise.png" class="mt-3"/> <h4><span class="weather-sunrise ml-2"></span> / <span class="weather-sunset mr-2"></span></h4><br>
          </div>
        </div>
      </div>

      <div id="footer">
        <div class="row mb-5">
          <div class="col-11 themed-grid-col">
            <span id="instagram"></span>
          </div>
        </div>
      </div> <!-- end footer -->

    </div>
  </body>
  <script>
    // Read Parameters
    var parsed_qs = parse_query_string(location.search);
    ParameterFerry = parsed_qs.ferry;
    ParameterFerryName = ParameterFerry.replace(/([A-Z])/g, ' $1').trim();
    ParameterInstagram = parsed_qs.instagram;

    // Show Time
    var dt = new Date();
    var date = hours_with_leading_zeros(dt) + ":" + minutes_with_leading_zeros(dt);
    document.getElementById("date").innerHTML = date;
    // Show Weekday
    var options = { weekday: 'long' };
    var weekday = new Intl.DateTimeFormat('en-US', options).format(dt);
    document.getElementById("weekday").innerHTML = weekday;
    // Show Day
    var day = dt.getDate();
    document.getElementById("day").innerHTML = day;
    // Show Month
    var options = { month: 'long' };
    var month = new Intl.DateTimeFormat('en-US', options).format(dt)
    document.getElementById("month").innerHTML = month;
    // Show Year
    var year = dt.getFullYear();
    document.getElementById("FerryScheduleName").innerHTML = ParameterFerryName;
    // Change Schedule Name
    document.getElementById("month").innerHTML = month;
    // Check for Holiday
    if (HongKongHolidays.includes(day + month) || weekday == 'Sunday') {
      Calendar = "Holiday";
      document.getElementById("HolidayFlag").innerHTML = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-sunglasses" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 7a1 1 0 0 0-1 1H6a2 2 0 1 1 4 0H9a1 1 0 0 0-1-1zM0 8a.5.5 0 0 1 .5-.5h1v1h-1A.5.5 0 0 1 0 8zm15.5.5h-1v-1h1a.5.5 0 0 1 0 1z"/><path fill-rule="evenodd" d="M3 5a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h1a3 3 0 0 0 3-3V7a2 2 0 0 0-2-2H3zm0 1a1 1 0 0 0-1 1v.941c0 .264.356.348.474.112l.228-.457a2 2 0 0 1 .894-.894l.457-.228C4.289 6.356 4.205 6 3.94 6H3z"/><path fill-rule="evenodd" d="M2.023 6.784C2.008 6.854 2 6.926 2 7v.941c0 .264.356.348.474.112l.228-.457a2 2 0 0 1 .894-.894l.457-.228C4.289 6.356 4.205 6 3.94 6H3a1.001 1.001 0 0 0-.977.784zm3.146-.77A1.219 1.219 0 0 1 4.5 7.368l-.457.228a1 1 0 0 0-.447.447l-.228.457a1.22 1.22 0 0 1-1.354.669A1 1 0 0 0 3 10h1a2 2 0 0 0 2-2V7a1 1 0 0 0-.831-.986zM1 7a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1a3 3 0 0 1-3 3H3a2 2 0 0 1-2-2V7z"/><path d="M9 7a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1a3 3 0 0 1-3-3V7z"/><path fill-rule="evenodd" d="M13 6h-2a1 1 0 0 0-1 1v1a2 2 0 0 0 2 2h1a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1zm-2-1a2 2 0 0 0-2 2v1a3 3 0 0 0 3 3h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2z"/></svg>';
    }
    // Show Ferry Schedule
    $.getJSON("ferry/" + ParameterFerry + "-" + Calendar + ".json", function(data) {
      for (var i=0;i<data.length;++i) {
        var FerryType = data[i].type;
        var FerryTime = data[i].dep.split(":");
        var NextFerry = new Date();
        NextFerry.setHours(FerryTime[0]);
        NextFerry.setMinutes(FerryTime[1]);
        NextFerry.setSeconds(0);
        // check if we have a ferry for you
        if (new Date(NextFerry) > new Date()) {
          FerryCount += 1;
          var TimeDifferenceMins = diff_minutes(NextFerry,dt);
          var Other = diff_minutes(NextFerry,dt);
          var MinuteText = TimeDifferenceMins == 1 ? " minute" : " minutes";
          var FullText = FerryTime[0] + ":" + FerryTime[1]
          if (TimeDifferenceMins < 55) {
            FullText += " <small>in " + TimeDifferenceMins + MinuteText + '</small>'
          }
          if (FerryType == 'fast') {
            FullText = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-lightning-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"/></svg> ' + FullText;
          } else {
            FullText = '<svg width="1em" height="1em"/></svg> ' + FullText;
          }
          $("#FullText").append(FullText + '<br>');
        }
        if (FerryCount > maxFerry) {
          break;
        }
      }
    });
  </script>
  <script>
    $(function() {
      $('.weather-temperature').openWeather({
        // not my key!
        key: 'c9d49310f8023ee2617a7634de23c2aa',
        //city: 'Hong Kong',
        lat: '22.32',
        lng: '114.18',
        units: 'c',
        descriptionTarget: EnableTemperature ? '.weather-description' : '',
        windSpeedTarget: EnableWind ? '.weather-wind-speed' : '',
        minTemperatureTarget: EnableTemperature ? '.weather-min-temperature' : '',
        maxTemperatureTarget: EnableTemperature ? '.weather-max-temperature' : '',
        humidityTarget: EnableHumidity ? '.weather-humidity' : '',
        sunriseTarget: EnableSunrise ? '.weather-sunrise' : '',
        sunsetTarget: EnableSunrise ?  '.weather-sunset' : '',
        iconTarget: '.weather-icon',
        customIcons: 'dist/img/weather/',
        success: function(data) {
          EnableSunrise ? $('#sunrise').show() : '';
          EnableWind ? $('#wind').show() : '';
          EnableHumidity ? $('#humidity').show() : '';
          EnableTemperature ? $('#temperature').show() : '';
        },
        error: function(data) {
        }
      });
    });
  </script>
  <script>
    // Instagram
    $.instagramFeed({
      'tag': ParameterInstagram,
      'container': "#instagram",
      'display_profile': false,
      'display_biography': false,
      'display_gallery': true,
      'callback': null,
      'styling': true,
      'items': 4,
      'items_per_row': 4,
      'margin': 0.50
    });
  </script>
</html>
